import urllib
from humps import camelize
from pydantic import BaseModel, Field
from typing import Dict, Sequence
from collections.abc import Iterable

def as_query_params(key: str, value: Any) -> Dict[str, Union[str, Sequence[str]]]:
    if isinstance(value, CamelModel):
        return value.as_query_parameters(key)
    elif isinstance(value, Iterable):
        return {key: [str(item) for item in value]}
    else:
        return {key: str(value)}


class CamelModel(BaseModel):
    """Convert snake_case names automatically to camelCase."""

    class Config:
        """Picked up by BaseModel baseclass."""

        alias_generator = camelize
        allow_population_by_field_name = True

    def as_query_parameters(self, param_name: str) -> Dict[str, str]:
        data = {param_name: self.dict()}
        parents = list()
        pairs = dict()

        def renderKey(parents):
            depth, outStr = 0, ''
            for x in parents:
                s = "[%s]" if depth > 0 or isinstance(x, int) else "%s"
                outStr += s % str(x)
                depth += 1
            return outStr

        def r_urlencode(data):
            if isinstance(data, list) or isinstance(data, tuple):
                for i in range(len(data)):
                    parents.append(i)
                    r_urlencode(data[i])
                    parents.pop()
            elif isinstance(data, dict):
                for key, value in data.items():
                    parents.append(key)
                    r_urlencode(value)
                    parents.pop()
            else:
                pairs[renderKey(parents)] = urllib.parse.quote_plus(str(data))

            return pairs
        return r_urlencode(data)
